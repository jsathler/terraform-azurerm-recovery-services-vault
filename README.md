<!-- BEGIN_TF_DOCS -->
# Azure Recovery Services Vault Terraform module

Terraform module which creates Azure Recovery Services Vault resources on Azure.

Supported Azure services:

* [Azure Recovery Services vaults](https://learn.microsoft.com/en-us/azure/backup/backup-azure-recovery-services-vault-overview)
* [Azure VM backups](https://learn.microsoft.com/en-us/azure/backup/backup-support-matrix-iaas)
* [SQL Server Backup in Azure VMs](https://learn.microsoft.com/en-us/azure/backup/sql-support-matrix)
* [SAP HANA databases on Azure VMs](https://learn.microsoft.com/en-us/azure/backup/sap-hana-backup-support-matrix)
* [Azure file share backup](https://learn.microsoft.com/en-us/azure/backup/azure-file-share-support-matrix)

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.5.6 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >= 3.70.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >= 3.70.0 |

## Resources

| Name | Type |
|------|------|
| [azurerm_backup_policy_file_share.default](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/backup_policy_file_share) | resource |
| [azurerm_backup_policy_vm.default](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/backup_policy_vm) | resource |
| [azurerm_backup_policy_vm_workload.default](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/backup_policy_vm_workload) | resource |
| [azurerm_recovery_services_vault.default](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/recovery_services_vault) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_fileshare_policy"></a> [fileshare\_policy](#input\_fileshare\_policy) | A MAP of policies for file shares, the key is the policy name and the value are the properties.<br>  - frequency:                      (required) Sets the backup frequency. Possible values are Daily and Hourly. Defaults to 'Daily'<br>  - time:                           (required) The time of day to perform the backup in 24hour format. Defaults to '22:00'<br>  - timezone:                       (optional) Specifies the timezone. the possible values are defined here. Defaults to 'UTC'<br>  - daily\_retention:                (required) The number of daily backups to keep. Must be between 7 and 9999. Defaults to 7<br>  - hourly:                         (optional) A hourly block defined as below. This is required when frequency is set to Hourly<br>    - interval:                     (optional) Specifies the interval at which backup needs to be triggered. Possible values are 4, 6, 8 and 12. Defaults to 4<br>    - start\_time:                   (optional) Specifies the start time of the hourly backup. The time format should be in 24-hour format. Defaults to "00:00"<br>    - window\_duration:              (optional) Species the duration of the backup window in hours. Defaults to '8'<br>  - retention\_weekly:               (optional) A block as defined bellow<br>    - count:                        (required) The number of weekly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - weekdays:                     (required) The weekday backups to retain. Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>  - retention\_monthly:              (optional) A block as defined bellow<br>    - count:                        (required) The number of monthly backups to keep. Must be between 1 and 9999. Defaults to 12<br>    - weekdays:                     (optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (optional) Including the last day of the month, default to false<br>  - retention\_yearly:               (optional) A block as defined bellow<br>    - count:                        (required) The number of yearly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - months:                       (required) The months of the year to retain backups of. Must be one of January, February, March, April, May, June, July, August, September, October, November and December. Defaults to 'January'<br>    - weekdays:                     (optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (optional) Including the last day of the month, default to 'null' | <pre>map(object({<br>    frequency       = optional(string, "Daily")<br>    time            = optional(string, "22:00")<br>    timezone        = optional(string, "UTC")<br>    daily_retention = optional(number, 7)<br><br>    hourly = optional(object({<br>      interval        = optional(number, 4)<br>      start_time      = optional(string, "00:00")<br>      window_duration = optional(number, 8)<br>    }), null)<br><br>    retention_weekly = optional(object({<br>      count    = optional(number, 5)<br>      weekdays = optional(list(string), ["Saturday"])<br>    }), null)<br><br>    retention_monthly = optional(object({<br>      count             = optional(number, 12)<br>      weekdays          = optional(list(string), ["Saturday"])<br>      weeks             = optional(list(string), ["First"])<br>      days              = optional(list(number), null)<br>      include_last_days = optional(bool, null)<br>    }), null)<br><br>    retention_yearly = optional(object({<br>      count             = optional(number, 5)<br>      months            = optional(list(string), ["January"])<br>      weekdays          = optional(list(string), ["Saturday"])<br>      weeks             = optional(list(string), ["First"])<br>      days              = optional(list(number), null)<br>      include_last_days = optional(bool, null)<br>    }), null)<br>  }))</pre> | `null` | no |
| <a name="input_location"></a> [location](#input\_location) | The region where the VM will be created. This parameter is required | `string` | `"northeurope"` | no |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | The name of the resource group in which the resources will be created. This parameter is required | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to be applied to resources. | `map(string)` | `null` | no |
| <a name="input_vault"></a> [vault](#input\_vault) | Recovery Services Vault properties<br>  - name:                                               (required) Specifies the name of the Recovery Services Vault. Recovery Service Vault name must be 2 - 50 characters long<br>  - sku:                                                (optional) Sets the vault's SKU. Possible values include: Standard, RS0. Defaults to 'Standard'<br>  - soft\_delete\_enabled:                                (optional) Is soft delete enable for this Vault? Defaults to 'true'<br>  - public\_network\_access\_enabled:                      (optional) Is it enabled to access the vault from public networks. Defaults to 'true'<br>  - storage\_mode\_type:                                  (optional) The storage type of the Recovery Services Vault. Possible values are GeoRedundant, LocallyRedundant and ZoneRedundant. Defaults to 'ZoneRedundant'<br>  - cross\_region\_restore\_enabled:                       (optional) Is cross region restore enabled for this Vault? Only can be true, when storage\_mode\_type is GeoRedundant. Defaults to 'false'<br>  - immutability:                                       (optional) Immutability Settings of vault, possible values include: Locked, Unlocked and Disabled. Defaults to 'Unlocked'<br>  - identity:                                           (optional) A block as defined bellow <br>     - type:                                            (required) Specifies the type of Managed Service Identity that should be configured on this Recovery Services Vault. Possible values are 'SystemAssigned', 'UserAssigned', 'SystemAssigned, UserAssigned'<br>     - identity\_ids:                                    (optional) A list of User Assigned Managed Identity IDs to be assigned to this RSV<br>  - encryption:                                         (optional) A block as defined bellow <br>     - key\_id:                                          (required) The Key Vault key id used to encrypt this vault<br>     - infrastructure\_encryption\_enabled:               (required) Enabling/Disabling the Double Encryption state. Defaults to 'false'<br>     - user\_assigned\_identity\_id:                       (optional) Specifies the user assigned identity ID to be used<br>     - use\_system\_assigned\_identity:                    (optional) Indicate that system assigned identity should be used or not. If you want to enable encryption during RSV creation, you should use User assigned Managed Identity. Defaults to 'false'<br>  - monitoring:                                         (optional) A block as defined bellow <br>     - alerts\_for\_all\_job\_failures\_enabled:             (optional) Enabling/Disabling built-in Azure Monitor alerts for security scenarios and job failure scenarios. Defaults to 'false'<br>     - alerts\_for\_critical\_operation\_failures\_enabled:  (optional) Enabling/Disabling alerts from the older (classic alerts) solution. Defaults to 'true' | <pre>object({<br>    name                          = string<br>    sku                           = optional(string, "Standard")<br>    soft_delete_enabled           = optional(bool, true)<br>    public_network_access_enabled = optional(bool, true)<br>    storage_mode_type             = optional(string, "ZoneRedundant")<br>    cross_region_restore_enabled  = optional(bool, false)<br>    immutability                  = optional(string, "Unlocked")<br><br>    identity = optional(object({<br>      type         = string<br>      identity_ids = optional(list(string), null)<br>    }), null)<br><br>    encryption = optional(object({<br>      key_id                            = string<br>      infrastructure_encryption_enabled = optional(bool, false)<br>      user_assigned_identity_id         = optional(string, null)<br>      use_system_assigned_identity      = optional(bool, false)<br>    }), null)<br><br>    monitoring = optional(object({<br>      alerts_for_all_job_failures_enabled            = optional(bool, false)<br>      alerts_for_critical_operation_failures_enabled = optional(bool, true)<br>    }), null)<br>  })</pre> | `null` | no |
| <a name="input_vm_policy"></a> [vm\_policy](#input\_vm\_policy) | A MAP of policies for virtual machines, the key is the policy name and the value are the properties.<br>  - frequency:                      (Required) Sets the backup frequency. Possible values are Hourly, Daily and Weekly. Defaults to 'Daily'<br>  - time:                           (Required) The time of day to perform the backup in 24hour format. Defaults to '22:00'<br>  - timezone:                       (Optional) Specifies the timezone. the possible values are defined here. Defaults to 'UTC'<br>  - policy\_type:                    (Optional) Type of the Backup Policy. Possible values are V1 and V2 where V2 stands for the Enhanced Policy. Defaults to 'V2'<br>  - instant\_restore\_retention\_days: (Optional) Specifies the instant restore retention range in days. Possible values are between 1 and 5 when policy\_type is V1, and 1 to 30 when policy\_type is V2. Defaults to '3'<br>  - hour\_interval:                  (Optional) Interval in hour at which backup is triggered. Possible values are 4, 6, 8 and 12. This is used when frequency is Hourly. Defaults to 8<br>  - hour\_duration:                  (Optional) Duration of the backup window in hours. Possible values are between 4 and 24 This is used when frequency is Hourly. Defaults to 16<br>  - weekdays:                       (Optional) The days of the week to perform backups on. Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. This is used when frequency is Weekly<br>  - daily\_retention:                (optional) The number of daily backups to keep. Must be between 7 and 9999. It is required if frequency is 'Daily' or 'Hourly'. Defaults to 7<br>  - instant\_restore\_resource\_group: (optional) Specifies the instant restore resource group name. A block as defined bellow <br>    - prefix:                       (Required) The prefix for the instant\_restore\_resource\_group name.<br>    - suffix:                       (Optional) The suffix for the instant\_restore\_resource\_group name.<br>  - retention\_weekly:               (optional) A block as defined bellow<br>    - count:                        (Required) The number of weekly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - weekdays:                     (Required) The weekday backups to retain. Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>  - retention\_monthly:              (optional) A block as defined bellow<br>    - count:                        (Required) The number of monthly backups to keep. Must be between 1 and 9999. Defaults to 12<br>    - weekdays:                     (Optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (Optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (Optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (Optional) Including the last day of the month, default to false<br>  - retention\_yearly:               (optional) A block as defined bellow<br>    - count:                        (Required) The number of yearly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - months:                       (Required) The months of the year to retain backups of. Must be one of January, February, March, April, May, June, July, August, September, October, November and December. Defaults to 'January'<br>    - weekdays:                     (Optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (Optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (Optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (Optional) Including the last day of the month, default to 'null' | <pre>map(object({<br>    frequency                      = optional(string, "Daily")<br>    time                           = optional(string, "22:00")<br>    timezone                       = optional(string, "UTC")<br>    policy_type                    = optional(string, "V2")<br>    instant_restore_retention_days = optional(number, 3)<br>    hour_interval                  = optional(number, 8)<br>    hour_duration                  = optional(number, 16)<br>    weekdays                       = optional(list(string), null)<br>    daily_retention                = optional(number, 7)<br><br>    instant_restore_resource_group = optional(object({<br>      prefix = optional(string, null)<br>      suffix = optional(string, null)<br>    }), null)<br><br>    retention_weekly = optional(object({<br>      count    = optional(number, 5)<br>      weekdays = optional(list(string), ["Saturday"])<br>    }), null)<br><br>    retention_monthly = optional(object({<br>      count             = optional(number, 12)<br>      weekdays          = optional(list(string), ["Saturday"])<br>      weeks             = optional(list(string), ["First"])<br>      days              = optional(list(number), null)<br>      include_last_days = optional(bool, null)<br>    }), null)<br><br>    retention_yearly = optional(object({<br>      count             = optional(number, 5)<br>      months            = optional(list(string), ["January"])<br>      weekdays          = optional(list(string), ["Saturday"])<br>      weeks             = optional(list(string), ["First"])<br>      days              = optional(list(number), null)<br>      include_last_days = optional(bool, null)<br>    }), null)<br>  }))</pre> | `null` | no |
| <a name="input_workload_policy"></a> [workload\_policy](#input\_workload\_policy) | A MAP of policies for SAP for Hana and MSSQL, the key is the policy name and the value are the properties.<br>  - frequency:                      (optional) Sets the backup frequency. Possible values are Daily and Hourly. Defaults to 'Daily'<br>  - time:                           (optional) The time of day to perform the backup in 24hour format. Defaults to '22:00'<br>  - timezone:                       (optional) Specifies the timezone. the possible values are defined here. Defaults to 'UTC'<br>  - daily\_retention:                (optional) The number of daily backups to keep. Must be between 7 and 9999. Defaults to 7<br>  - log:                            (optional) A block as defined bellow. On SAP for HANA policies, this parameter is required<br>    - frequency\_in\_minutes:         (optional) The backup frequency in minutes for the VM Workload Backup Policy. Possible values are 15, 30, 60, 120, 240, 480, 720 and 1440. Defaults to 60<br>    - count:                        (optional) The count that is used to count retention duration with duration type Days. Possible values are between 7 and 35. Defaults to 7<br>  - incremental:                    (optional) A block as defined bellow. This options is only supported on SAP for HANA policies<br>    - weekdays:                     (optional) The days of the week to perform backups on. Possible values are Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. This is used when frequency is Weekly. Defaults to '["Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]'<br>    - time:                         (optional) The time of day to perform the backup in 24hour format. Defaults to '22:00'<br>    - count:                        (optional) The count that is used to count retention duration with duration type Days. Possible values are between 7 and 35. Defaults to 7<br>  - differential:                   (optional) A block as defined bellow<br>    - weekdays:                     (optional) The days of the week to perform backups on. Possible values are Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. This is used when frequency is Weekly. Defaults to '["Sunday","Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]'<br>    - time:                         (optional) The time of day to perform the backup in 24hour format. Defaults to '22:00'<br>    - count:                        (optional) The count that is used to count retention duration with duration type Days. Possible values are between 7 and 35. Defaults to 7<br>  - retention\_weekly:               (optional) A block as defined bellow<br>    - count:                        (required) The number of weekly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - weekdays:                     (required) The weekday backups to retain. Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>  - retention\_monthly:              (optional) A block as defined bellow<br>    - count:                        (required) The number of monthly backups to keep. Must be between 1 and 9999. Defaults to 12<br>    - weekdays:                     (optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (optional) Including the last day of the month, default to false<br>  - retention\_yearly:               (optional) A block as defined bellow<br>    - count:                        (required) The number of yearly backups to keep. Must be between 1 and 9999. Defaults to 5<br>    - months:                       (required) The months of the year to retain backups of. Must be one of January, February, March, April, May, June, July, August, September, October, November and December. Defaults to 'January'<br>    - weekdays:                     (optional) The weekday backups to retain . Must be one of Sunday, Monday, Tuesday, Wednesday, Thursday, Friday or Saturday. Defaults to 'Saturday'<br>    - weeks:                        (optional) The weeks of the month to retain backups of. Must be one of First, Second, Third, Fourth, Last. Defaults to 'First'<br>    - days:                         (optional) The days of the month to retain backups of. Must be between 1 and 31.<br>    - include\_last\_days:            (optional) Including the last day of the month, default to 'null' | <pre>map(object({<br>    frequency           = optional(string, "Daily")<br>    time                = optional(string, "22:00")<br>    timezone            = optional(string, "UTC")<br>    daily_retention     = optional(number, 7)<br>    compression_enabled = optional(bool, false)<br>    workload_type       = optional(string, "SQLDataBase")<br>    weekdays            = optional(list(string), ["Saturday"])<br><br>    log = optional(object({<br>      frequency_in_minutes = optional(number, 60)<br>      count                = optional(number, 7)<br>    }), null)<br><br>    incremental = optional(object({<br>      weekdays = optional(list(string), ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"])<br>      time     = optional(string, "22:00")<br>      count    = optional(number, 7)<br>    }), null)<br><br>    differential = optional(object({<br>      weekdays = optional(list(string), ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"])<br>      time     = optional(string, "22:00")<br>      count    = optional(number, 7)<br>    }), null)<br><br>    retention_weekly = optional(object({<br>      count    = optional(number, 5)<br>      weekdays = optional(list(string), ["Saturday"])<br>    }), null)<br><br>    retention_monthly = optional(object({<br>      count     = optional(number, 12)<br>      weekdays  = optional(list(string), ["Saturday"])<br>      weeks     = optional(list(string), ["First"])<br>      monthdays = optional(list(number), null)<br>    }), null)<br><br>    retention_yearly = optional(object({<br>      count     = optional(number, 5)<br>      months    = optional(list(string), ["January"])<br>      weekdays  = optional(list(string), ["Saturday"])<br>      weeks     = optional(list(string), ["First"])<br>      monthdays = optional(list(number), null)<br>    }), null)<br>  }))</pre> | `null` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_fs_policy_ids"></a> [fs\_policy\_ids](#output\_fs\_policy\_ids) | File Share backup policy IDs |
| <a name="output_rsv_id"></a> [rsv\_id](#output\_rsv\_id) | Recovery Services Vault ID |
| <a name="output_rsv_name"></a> [rsv\_name](#output\_rsv\_name) | Recovery Services Vault name |
| <a name="output_vm_policy_ids"></a> [vm\_policy\_ids](#output\_vm\_policy\_ids) | VM backup policy IDs |
| <a name="output_workload_policy_ids"></a> [workload\_policy\_ids](#output\_workload\_policy\_ids) | MSSQL/SAPHANA backup policy IDs |

## Examples
```hcl
module "prd-rsv" {
  source              = "jsathler/recovery-services-vault/azurerm"
  resource_group_name = azurerm_resource_group.default.name
  location            = azurerm_resource_group.default.location

  vault = {
    name              = "prd"
    storage_mode_type = "GeoRedundant"
  }

  vm_policy = {
    "default-vm" = { retention_weekly = {}, retention_monthly = {}, retention_yearly = {} }
    "hourly-vm"  = { frequency = "Hourly", retention_weekly = {}, retention_monthly = {}, retention_yearly = {} }
  }
  fileshare_policy = {
    "default-fs" = { retention_weekly = {}, retention_monthly = {}, retention_yearly = {} }
    "hourly-fs"  = { frequency = "Hourly", hourly = {}, retention_weekly = {}, retention_monthly = {}, retention_yearly = { count = 5 } }
  }

  workload_policy = {
    default-mssql       = { retention_weekly = {}, retention_monthly = {}, retention_yearly = {} }
    full-log-mssql      = { compression_enabled = true, retention_weekly = {}, retention_monthly = {}, retention_yearly = {}, log = {} }
    full-diff-log-mssql = { frequency = "Weekly", retention_weekly = {}, retention_monthly = {}, retention_yearly = {}, differential = { time = "01:00" }, log = {} }

    # SAP for HANA requires Log backup
    default-saphana       = { workload_type = "SAPHanaDatabase", retention_weekly = {}, retention_monthly = {}, retention_yearly = {}, log = {} }
    full-inc-log-saphana  = { workload_type = "SAPHanaDatabase", frequency = "Weekly", retention_weekly = {}, retention_monthly = {}, retention_yearly = {}, incremental = { time = "01:00" }, log = {} }
    full-diff-log-saphana = { workload_type = "SAPHanaDatabase", frequency = "Weekly", retention_weekly = {}, retention_monthly = {}, retention_yearly = {}, differential = { time = "01:00" }, log = {} }
  }
}
```
More examples in ./examples folder
<!-- END_TF_DOCS -->